<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Users</title>
    <link rel="stylesheet" href="assets/css/style.css">
    <style>
      body{background:#0b1022}
      header{display:none}
      .app{display:grid;grid-template-columns:240px 1fr;min-height:100vh}
      .sidebar{background:#0f1630;border-right:1px solid #1d2a52;padding:20px;position:sticky;top:0;height:100vh}
      .brand{color:#c8d7ff;font-weight:800;letter-spacing:.4px;margin-bottom:16px}
      .menu{display:flex;flex-direction:column;gap:8px}
      .menu a{color:#a9b8e8;text-decoration:none;padding:10px 12px;border-radius:8px}
      .menu a.active,.menu a:hover{background:#172349;color:#e7f1ff}
      .content{padding:20px}
      .page-title{font-size:28px;margin:0 0 14px;color:#e7f1ff}
      .grid{display:grid;grid-template-columns:360px 1fr;gap:12px}
      @media(max-width:900px){.app{grid-template-columns:1fr}.sidebar{position:relative;height:auto}.grid{grid-template-columns:1fr}}
      .card.white{background:#111a35;border-radius:12px;border:1px solid #1d2a52;padding:16px;box-shadow:0 8px 18px rgba(0,0,0,.2);color:#dbe8ff}
      .row{display:flex;gap:10px;margin-bottom:10px}
      .row input, .row select{flex:1}
      .actions-cell a.link{color:#2563eb;text-decoration:none;margin-right:12px}
      .actions-cell a.link.danger{color:#ef4444}
      th, td{padding:10px}
      .searchbar{display:flex;gap:10px;align-items:center;margin-bottom:10px}
    </style>
  </head>
  <body>
    <div class="app">
      <aside class="sidebar">
        <div class="brand">Inventory MS</div>
        <nav class="menu">
          <a href="dashboard.html">Dashboard</a>
          <a href="products.html">Products</a>
          <a href="categories.html">Categories</a>
          <a href="admin-orders.html">Orders</a>
          <a href="suppliers.html">Suppliers</a>
          <a class="active" href="users.html">Users</a>
          <a href="profile.html">Profile</a>
          <a class="logout" href="index.html">Logout</a>
        </nav>
      </aside>
      <main class="content">
        <h1 class="page-title">Users Management</h1>
        <div class="grid">
          <div class="card white">
            <h3 style="margin:0 0 8px">Add New User</h3>
            <form id="form">
              <div class="row"><input name="name" placeholder="User Name" required></div>
              <div class="row"><input name="email" placeholder="User Email" required></div>
              <div class="row"><input name="password" type="password" placeholder="Password" required></div>
              <div class="row"><input name="address" placeholder="User Address"></div>
              <div class="row"><select name="role"><option value="user">user</option><option value="admin">admin</option></select></div>
              <div class="row">
                <button class="primary" type="submit">Add User</button>
                <button type="button" id="btn-cancel" style="display:none">Cancel</button>
              </div>
            </form>
          </div>
          <div>
            <div class="card white">
              <div class="searchbar">
                <input id="search" placeholder="Search users...">
              </div>
              <div style="overflow:auto">
                <table>
                  <thead>
                    <tr><th style="width:80px">ID</th><th>Name</th><th>Email</th><th>Role</th><th style="width:120px">Action</th></tr>
                  </thead>
                  <tbody id="rows"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>

    <script>
      // Read current admin session
      let CURRENT_USER=null; try{ CURRENT_USER = JSON.parse(sessionStorage.getItem('ims_current_user')||'null'); }catch(e){ CURRENT_USER=null }
      if(!CURRENT_USER){ location.href='login.html'; }
      const rows = document.getElementById('rows');
      const form = document.getElementById('form');
      const btnCancel = document.getElementById('btn-cancel');
      let editingId = null;

      const LocalUsers = {
        _key: 'ims_users',
        _read(){ try { return JSON.parse(localStorage.getItem(this._key)||'[]')||[] } catch(e){ return [] } },
        _write(list){ localStorage.setItem(this._key, JSON.stringify(list)); },
        async list(q){ const list=this._read(); if(!q) return list; const s=String(q).toLowerCase(); return list.filter(u=>[u.name,u.email,u.role].some(v=>String(v||'').toLowerCase().includes(s))); },
        async get(id){ return this._read().find(u=>String(u.id)===String(id)); },
        async create(data){ const list=this._read(); const id=Date.now().toString(); const u={id, approved:true, createdBy:'admin', ownerEmail: (CURRENT_USER && CURRENT_USER.email)||'', ...data}; list.push(u); this._write(list); return u; },
        async update(id, data){ const list=this._read(); const i=list.findIndex(u=>String(u.id)===String(id)); if(i>-1){ list[i] = { ...list[i], ...data, id:list[i].id }; this._write(list); return list[i]; } throw new Error('Not found'); },
        async remove(id){ const list=this._read().filter(u=>String(u.id)!==String(id)); this._write(list); return { ok:true }; }
      };
      const Store = LocalUsers;

      async function load(q){
        const list = await Store.list(q);
        rows.innerHTML = '';
        list.forEach((u, idx)=>{
          const tr=document.createElement('tr');
          tr.innerHTML = `<td>${idx+1}</td><td>${u.name||''}</td><td>${u.email||''}</td><td>${u.role||''}</td><td class="actions-cell"><a href="#" class="link danger" data-del="${u.id}">Delete</a></td>`;
          rows.appendChild(tr);
        });
      }

      document.getElementById('search').addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); load(e.target.value);} });

      rows.addEventListener('click', async (e)=>{
        if(e.target.dataset.del){
          if(confirm('Delete user?')){
            try{ await Store.remove(e.target.dataset.del); load(); }catch(err){ alert(err.message||'Delete failed'); }
          }
        }
      });

      btnCancel.onclick = () => { editingId=null; form.reset(); btnCancel.style.display='none'; form.querySelector('button.primary').textContent='Add User'; };

      form.onsubmit = async (e) => {
        e.preventDefault();
        const raw = Object.fromEntries(new FormData(form).entries());
        const data = {
          name: String(raw.name||'').trim(),
          email: String(raw.email||'').trim().toLowerCase(),
          password: String(raw.password||'').trim(),
          address: String(raw.address||'').trim(),
          role: raw.role ? String(raw.role) : 'user'
        };
        try{
          if(editingId){
            await Store.update(editingId, data);
          } else {
            // prevent duplicate emails
            const existing = (await Store.list()).some(u => String(u.email||'').toLowerCase() === data.email);
            if(existing){ alert('Email already exists'); return; }
            await Store.create(data);
          }
          btnCancel.click();
          load();
        }catch(err){ alert(err.message||'Save failed'); }
      };

      load();
    </script>
  </body>
</html>
