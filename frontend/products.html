<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Products</title>
  <link rel="stylesheet" href="assets/css/style.css">

  <style>
    .actions-cell {
      text-align: left;
      padding-left: 8px;
    }

    .actions-cell a.link {
      color: #2563eb;
      text-decoration: none;
      margin-right: 12px;
    }

    .actions-cell a.link.danger {
      color: #ef4444;
    }

    .card table thead th:last-child {
      text-align: left;
      padding-left: 8px;
    }

    .card table thead th:nth-child(5),
    .card table tbody td:nth-child(5) {
      text-align: center;
    }
  </style>
</head>

<body>

  <header>
    <h1>Products</h1>
    <nav class="nav">
      <a class="navlink" href="dashboard.html">Dashboard</a>
      <a class="navlink active" href="products.html">Products</a>
    </nav>
  </header>

  <div class="container">

    <div class="card">
      <div class="flex">

        <input id="search" placeholder="Search products by name or category...">
        <button class="primary" id="btn-search">Search</button>

        <div class="right" style="flex:1"></div>

        <button class="primary" id="btn-new">Add Product</button>

      </div>
    </div>

    <div class="card">
      <table>
        <thead>
          <tr>
            <th>Name</th>
            <th>Category</th>
            <th>Supplier</th>
            <th>Price</th>
            <th>Stock</th>
            <th>Action</th>
          </tr>
        </thead>

        <tbody id="rows"></tbody>
      </table>
    </div>

    <div class="card" id="form-card" style="display:none">
      <form id="form">

        <div class="row">
          <input name="name" placeholder="Name" required>
          <input name="category" placeholder="Category">
          <input name="supplier" placeholder="Supplier">
        </div>

        <div class="row">
          <input name="sell_price" type="number" step="0.01" placeholder="Price">
          <input name="quantity" type="number" placeholder="Stock">
        </div>

        <div class="row actions">
          <button class="primary" type="submit">Save</button>
          <button type="button" id="btn-cancel">Cancel</button>
        </div>

      </form>
    </div>

  </div>

  <script src="assets/js/api.js"></script>

  <script>
    const rows = document.getElementById('rows');
    const formCard = document.getElementById('form-card');
    const form = document.getElementById('form');

    let editingId = null;
    let currentProduct = null;

    // Session and per-user scoped local store
    let CURRENT_USER = null;

    try {
      CURRENT_USER = JSON.parse(sessionStorage.getItem('ims_current_user') || 'null');
    } catch (_e) {
      CURRENT_USER = null;
    }

    if (!CURRENT_USER) {
      location.href = 'login.html';
    }

    const PRODUCTS_KEY = `ims_products__${(CURRENT_USER && CURRENT_USER.email || '').toLowerCase()}`;

    const LocalProducts = {

      _key: PRODUCTS_KEY,

      _read() {
        try {
          return JSON.parse(localStorage.getItem(this._key) || '[]') || [];
        } catch (e) {
          return [];
        }
      },

      _write(list) {
        localStorage.setItem(this._key, JSON.stringify(list));
      },

      async list(q) {
        const list = this._read();
        if (!q) return list;
        const s = String(q).toLowerCase();
        return list.filter(p =>
          String(p.name || '').toLowerCase().includes(s) ||
          String(p.category || '').toLowerCase().includes(s)
        );
      },

      async get(id) {
        return this._read().find(p => String(p.id) === String(id));
      },

      async create(data) {
        const list = this._read();
        const id = Date.now().toString();
        const p = { id, ...data };
        list.push(p);
        this._write(list);
        return p;
      },

      async update(id, data) {
        const list = this._read();
        const i = list.findIndex(p => String(p.id) === String(id));

        if (i > -1) {
          list[i] = { ...list[i], ...data, id: list[i].id };
          this._write(list);
          return list[i];
        }

        throw new Error('Not found');
      },

      async remove(id) {
        const list = this._read().filter(p => String(p.id) !== String(id));
        this._write(list);
        return { ok: true };
      }
    };

    const Store = LocalProducts;

    function stockBadge(q) {
      const n = Number(q || 0);
      let cls = '';

      if (n <= 0) cls = 'danger-pill';
      else if (n <= 5) cls = 'warn-pill';
      else cls = 'success-pill';

      return `<span class="pill ${cls}">${n}</span>`;
    }

    async function load(q) {
      const list = await Store.list(q);
      rows.innerHTML = '';

      list.forEach(p => {
        const tr = document.createElement('tr');

        tr.innerHTML = `
          <td>${p.name}</td>
          <td>${p.category || ''}</td>
          <td>${p.supplier || ''}</td>
          <td>${p.sell_price}</td>
          <td>${stockBadge(p.quantity)}</td>
          <td class="actions-cell">
            <a href="#" data-edit="${p.id}" class="link">Edit</a>
            <a href="#" data-del="${p.id}" class="link danger">Delete</a>
          </td>
        `;

        rows.appendChild(tr);
      });
    }

    function showForm(show) {
      formCard.style.display = show ? 'block' : 'none';
    }

    document.getElementById('btn-new').onclick = () => {
      editingId = null;
      currentProduct = null;
      form.reset();
      showForm(true);
    };

    document.getElementById('btn-cancel').onclick = () => showForm(false);

    document.getElementById('btn-search').onclick = () =>
      load(document.getElementById('search').value);

    rows.addEventListener('click', async (e) => {

      if (e.target.dataset.edit) {
        const p = await Store.get(e.target.dataset.edit);

        editingId = p.id;
        currentProduct = p;

        for (const k of ['name', 'category', 'supplier', 'sell_price', 'quantity']) {
          form[k].value = p[k] ?? '';
        }

        showForm(true);
      }

      if (e.target.dataset.del) {
        if (confirm('Delete product?')) {
          try {
            await Store.remove(e.target.dataset.del);
            load();
          } catch (err) {
            alert(err.message || 'Delete failed');
          }
        }
      }
    });

    form.onsubmit = async (e) => {
      e.preventDefault();

      const data = Object.fromEntries(new FormData(form).entries());
      ['sell_price', 'quantity'].forEach(k => data[k] = Number(data[k] || 0));
      data.supplier = data.supplier || '';

      const payload = { ...data };

      try {
        if (editingId) {
          await Store.update(editingId, payload);
        } else {
          await Store.create(payload);
        }

        showForm(false);
        load();

      } catch (err) {
        alert(err.message || 'Save failed');
      }
    };

    load();
  </script>

</body>
</html>
